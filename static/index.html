<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <style>
        td{
            border: 1px solid black;
            padding: 10px;
        }
    </style>
</head>
<body>

    <h2>Monetki</h2>

    <table id="all">
        <tr>
            <td>Kraj</td>
            <td>Nominał</td>
            <td>Nr. katalogowy</td>
            <td>Stop</td>
            <td>Rok</td>
            <td>Usuń</td>
            <td>Update</td>
        </tr>
    </table>

    <h2>Dodawanie rekordu</h2>
    <select id="kraj" name="kraj">
    </select>
    <input id="nom" name="nom" type="text">
    <input id="nr" name="nr" type="number">
    <select id="stop" name="stop">
    </select>
    <input id="rok" name="rok" type="number">
    <input id="send" type="button" value="send">

    <script>
        fetchPostAsync = async () => {

            const data = JSON.stringify({
                kraj: document.getElementById("kraj").value,
                nom: document.getElementById("nom").value,
                nr: document.getElementById("nr").value,
                stop: document.getElementById("stop").value,
                rok: document.getElementById("rok").value
            })

            const options = {
                    method: "POST",
                    body: data,
            };

            let response = await fetch("/add", options)

            if (!response.ok)
                return response.status
            else
                return await response.json() // response.json

        }

        delFetchPostAsync = async (uuid) => {

            const options = {
                    method: "POST",
                    body: uuid,
            };

            let response = await fetch("/del", options)

            if (!response.ok)
                return response.status
            else
                return await response.text() // response.json

        }

        allFetchPostAsync = async () => {
            const options = {
                    method: "POST",
                    body: "",
            };

            let response = await fetch("/all", options)

            if (!response.ok)
                return response.status
            else
                return await response.json() // response.json

        }

        generateTable = (tab) => {

            for(i=0; i<tab.length; i++){
                addRecord(tab[i])
            }
        }

        generateSelects = (flagi, stopy) => {

            let kraj = document.getElementById("kraj")
            let stops = document.getElementById("stop")

            for(i=0; i<flagi.length; i++){
                let option = document.createElement("option")
                option.innerText = flagi[i].kraj
                option.value = flagi[i].kraj
                kraj.appendChild(option)
            }

            for(i=0; i<stopy.length; i++){
                let option = document.createElement("option")
                option.innerText = stopy[i].name
                option.value = stopy[i].name
                stops.appendChild(option)
            }
        }

        addRecord = (w) =>{
         let tr = document.createElement("tr")
            let kraj = document.createElement("td")   
            let nom = document.createElement("td")   
            let nr = document.createElement("td")   
            let stop = document.createElement("td")   
            let rok = document.createElement("td")   
            let del = document.createElement("td")   

            let delBtn = document.createElement("button")  
            delBtn.innerText = "usuń"
            del.onclick = async () => {
                let k = await delFetchPostAsync(w._id);
                tr.remove();
            }
            del.appendChild(delBtn) 
            let updateBtn = document.createElement("button")   

            kraj.innerText = w.kraj
            nom.innerText = w.nom
            nr.innerText = w.nr
            stop.innerText = w.stop
            rok.innerText = w.rok

            tr.appendChild(kraj)
            tr.appendChild(nom)
            tr.appendChild(nr)
            tr.appendChild(stop)
            tr.appendChild(rok)
            tr.appendChild(del)

            document.getElementById("all").appendChild(tr)
        }

        document.getElementById("send").onclick = async () => {
            let w = await fetchPostAsync()
            addRecord(w)
        }

        window.onload = async () => {
            let w = await allFetchPostAsync()
            generateTable(w.docs)
            generateSelects(w.flags, w.stops)
            console.log(w)
        }

    </script>

</body>
</html>